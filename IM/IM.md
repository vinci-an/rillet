1.  IM的应用场景
    聊天、视频和语音等软件和一些实时交互的场景
2.  一个完整的IM系统是怎样的
    客户端：用户用于收发消息的终端设备
    接入服务：接入服务可以认为是服务端的门户，为客户端提供消息收发的出入口，主要有四块功能：连接保持、协议解析、Session 维护和消息推送
    业务处理服务：真正的消息业务逻辑处理层
    存储服务：账号信息、关系链，以及消息本身，都需要进行持久化存储
    外部接口服务：第三方服务
3.  IM系统都有哪些特点
    实时性： 消息发送接收延迟低
    可靠性： 不丢消息、消息不重复
    一致性： 同一条消息，在多人、多终端需要保证展现顺序的一致性
    安全性： 从系统使用安全性的角度来看，首先是要求“数据传输安全”，其次是要求“数据存储安全”，最后就是“消息内容安全”
4.  如何解决消息实时性问题
    1） 短轮询、定期、高频地轮询服务端的新消息。 优点：简单易实现 缺点：高频请求对服务端资源的压力也较大
    2） 长轮询 本次请求没有获取到新消息时，并不会马上结束返回，而是会在服务端“悬挂（hang）”，等待一段时间；如果在等待的这段时间内有新消息产生，就能马上响应返回 优点：长轮询能大幅降低短轮询模式中客户端高频无用的轮询导致的网络开销和功耗开销，也降低了服务端处理请求的QPS 缺点：服务端悬挂（hang）住请求，只是降低了入口请求的 QPS，并没有减少对后端资源轮询的压力、长轮询在超时时间内没有获取到消息时，会结束返回，因此仍然没有完全解决客户端“无效”请求的问题。
    3） 服务端推送 WebSocket 优点：客户端和服务端只需要完成一次握手，就可以创建持久的长连接，并进行随时的双向数据传输。支持服务端推送的双向通信，大幅降低服务端轮询压力、数据交互的控制开销低，降低双方通信的网络开销、Web 原生支持，实现相对简单。
5.  如何保证消息可靠性投递？
    1） 业务层ACK，IM服务器在推送消息时，携带一个标识 SID（安全标识符，类似 TCP 的 sequenceId），推送出消息后会将当前消息添加到“待 ACK 消息列表”，客户端 B 成功接收完消息后，会给 IM 服务器回一个业务层的 ACK 包，包中携带有本条接收消息的 SID，IM 服务器接收后，会从“待 ACK 消息列表”记录中删除此条消息，本次推送才算真正结束
    2） ACK消息重传，IM 服务器的“等待 ACK 队列”一般都会维护一个超时计时器，一定时间内如果没有收到用户 B 回的 ACK 包，会从“等待 ACK 队列”中重新取出那条消息进行重推
    3） 消息重复推送问题 服务端推送消息时携带一个 Sequence ID，Sequence ID 在本次连接会话中需要唯一，针对同一条重推的消息 Sequence ID 不变，接收方根据这个唯一的 Sequence ID 来进行业务层的去重，这样经过去重后，对于用户 B 来说，看到的还是接收到一条消息，不影响使用体验。
    4） 消息完整性检查 IM服务器给接收方 B 推送 msg1，顺便带上一个最新的时间戳 timestamp1，接收方 B 收到 msg1 后，更新本地最新消息的时间戳为 timestamp1、 IM 服务器推送第二条消息 msg2，带上一个当前最新的时间戳 timestamp2，msg2 在推送过程中由于某种原因接收方 B 和 IM 服务器连接断开，导致 msg2 没有成功送达到接收方 B、 用户 B 重新连上线，携带本地最新的时间戳 timestamp1，IM 服务器将用户 B 暂存的消息中时间戳大于 timestamp1 的所有消息返回给用户 B，其中就包括之前没有成功的 msg2、用户 B 收到 msg2 后，更新本地最新消息的时间戳为 timestamp2
6.  如何保证消息时序不会乱序？
    IM服务端使用全局序号生成器，来做为时序基准。全局序号生成器常见的有redis原子命令incr、DB自带的自增、snowflake算法等。
    可用性问题：Redis 的原子自增和 DB 的自增 ID，都要求在主库上来执行“取号”操作，而主库基本都是单点部署，在可用性上的保障会相对较差，另外，针对高并发的取号操作这个单点的主库可能容易出现性能瓶颈。
    解决方案：对于群聊和多点登陆这种场景，没有必要保证全局的跨多个群的绝对时序性，只需要保证某一个群的消息有序即可
    消息服务端包内整流：在最终服务器取到 TCP 连接后下推的时候，根据包的 ID，对一定时间内的消息做一个整流和排序
    消息接收端整流:下推消息时，连同消息和序号一起推送给接收方、接收方收到消息后进行判定，如果当前消息序号大于前一条消息的序号，就将当前消息追加在会话里、否则继续往前查找倒数第二条、第三条等，一直查找到恰好小于当前推送消息的那条消息，然后插入在其后展示
7.  如何保证消息传输安全？
    1） 保证访问入口安全：HttpDNS，HttpDNS绕开运营商的localDNS，通过http协议直接和DNS服务器交互。
    2） 保证传输链路安全：TLS传输层加密协议
    3） 如何保证消息存储安全性
    4） 消息内容安全性
